#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]
[include AFC/*.cfg]
[include start_end_print.cfg]
[include led_effects.cfg]
[include led_progress.cfg]
[include orbiter_v2_smart_sensor.cfg]
[include pause_resume_savestate.cfg]
[include idle_timeout.cfg]
[include 99-useroverrides/99-afc_poop_zsafe.cfg]
[include user_overrides.cfg]


#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[ratos]
allow_unsupported_slicer_versions: True

[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "center"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_bed_heat_soak_time: 0
variable_hotend_heat_soak_time: 0
variable_beacon_contact_start_print_true_zero: True
variable_skew_profile: "my_skew"
#variable_beacon_contact_z_calibration: True

[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: SET_HEATER_TEMPERATURE_BASE
gcode:
    NEOPIXEL_DISPLAY LED=sb_leds TYPE=bed_temp MODE=glow
	# parameter
	{% set heater = params.HEATER|default("") %}
	{% set target = params.TARGET|default(0)|int %}

	DEBUG_ECHO PREFIX="SET_HEATER_TEMPERATURE" MSG="heater: {heater}, target: {target}"

	{% if heater|lower == "extruder" or heater|lower == "extruder1" %}
		# get physical toolhead
        NEOPIXEL_DISPLAY LED=sb_leds TYPE=extruder_temp MODE=glow
		{% set t = 0 if heater|lower == "extruder" else 1 %}

		# set temperature offset
		{% if printer["gcode_macro T%s" % t] is defined and target > 0 %}
			{% set temperature_offset = printer["gcode_macro T%s" % t].temperature_offset|default(0)|int %}
			{% set target = [target + temperature_offset, 0]|max %}
			{% if temperature_offset != 0 %}
				RATOS_ECHO PREFIX="SET_HEATER_TEMPERATURE" MSG="Temperature offset of {temperature_offset}Â°C added to toolhead T{t}."
			{% endif %}
            
		{% endif %}
        
	{% endif %}

	# call klipper base function
	SET_HEATER_TEMPERATURE_BASE HEATER="{heater}" TARGET={target}



#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact.
###    IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading
###    the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# mcu config for the AFC-Lite for Boxturtle
#------------------------------------------------------------------------------------------------------------
#[mcu AFC_Lite]
#serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_230022000751333235363331-if00
#restart_method: command

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin                 # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 500
position_endstop: 0

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin                 # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 500
position_endstop: 500

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4               # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 500

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4               # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4               # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin   # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63            # Orbiter 2 default
#pressure_advance: 0.05            # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300


[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

[exclude_object]


#############################################################################################################
### FANS
#############################################################################################################
# Part cooling fan
[fan]
# 4-pin fan connected to 2-pin header on T0 (EBB42 v1.2) - digital pwm
pin: !toolboard_t0:PA0
cycle_time:  0.01
 
# Controller cooling fan
[controller_fan controller_fan]
# 4-pin fan connected to 2-pin header on Octopus V1.1 F446 - digital pwm
pin: PD12
cycle_time:  0.00004

# HEPA Carbon Filter fan
[output_pin hepa_carbon_filter_fan]
pin: PD13 # Replace with your actual pin
value: 0  # Fan ON at startup (optional)
shutdown_value: 0

[input_shaper]
shaper_freq_x: 63.4
shaper_type_x: mzv
shaper_freq_y: 23.0
shaper_type_y: mzv

[heater_bed]
max_temp: 120


# REMEMBER TO CALIBRATE YOUR BEACON!
# Run BEACON_RATOS_CALIBRATE for automatic calibration.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.4559815603391195,
#*# 	  1.795407389837889,
#*# 	  0.7909448486978543,
#*# 	  0.41176197156868394,
#*# 	  0.2241964092999072,
#*# 	  0.022644534800908105,
#*# 	  -0.013561145339037552,
#*# 	  0.1568431548062696,
#*# 	  0.14140133445774494,
#*# 	  0.01657922340111429
#*# model_domain = 1.8146656403771785e-07,1.9302162799227418e-07
#*# model_range = 0.199896,4.999896
#*# model_temp = 53.298447
#*# model_offset = 0.00000
#*#
#*# [bed_mesh Preparation]
#*# version = 1
#*# points =
#*# 	-0.221066, -0.082376, 0.006228, 0.000271, -0.038651, -0.110918, -0.214453
#*# 	-0.302280, -0.139566, -0.026812, -0.005819, -0.024487, -0.093568, -0.221150
#*# 	-0.348195, -0.167058, -0.033471, -0.000838, -0.019474, -0.087883, -0.243437
#*# 	-0.382499, -0.170320, -0.012407, 0.023850, -0.007431, -0.104113, -0.264539
#*# 	-0.368295, -0.145569, 0.019261, 0.056680, 0.020885, -0.091045, -0.259793
#*# 	-0.316635, -0.079840, 0.077574, 0.116973, 0.073768, -0.033552, -0.211088
#*# 	-0.281037, -0.035207, 0.150763, 0.218775, 0.188059, 0.078288, -0.103463
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 465.0
#*# min_y = 30.0
#*# max_y = 460.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.138
#*# pid_ki = 2.195
#*# pid_kd = 560.227
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.477
#*# pid_ki = 8.840
#*# pid_kd = 33.615
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	-0.092518, -0.107662, -0.113015
#*# 	-0.077491, -0.097557, -0.110199
#*# 	-0.093622, -0.107063, -0.119434
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 206.772
#*# max_x = 293.228
#*# min_y = 204.728
#*# max_y = 270.666
#*#
#*# [skew_correction my_skew]
#*# xy_skew = 0.0040868846364686025
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.221800, -0.084488, 0.003941, 0.001417, -0.041409, -0.111586, -0.214798
#*# 	-0.301483, -0.137016, -0.024944, -0.005309, -0.024526, -0.092317, -0.220964
#*# 	-0.348026, -0.166680, -0.032576, 0.001956, -0.019064, -0.085955, -0.241726
#*# 	-0.379586, -0.166737, -0.009654, 0.026636, -0.006687, -0.103635, -0.263768
#*# 	-0.365811, -0.142102, 0.020240, 0.058683, 0.023204, -0.089118, -0.258289
#*# 	-0.314977, -0.079111, 0.078733, 0.118032, 0.074052, -0.033740, -0.209747
#*# 	-0.281213, -0.034697, 0.152547, 0.221042, 0.187904, 0.078710, -0.104324
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 465.0
#*# min_y = 30.0
#*# max_y = 460.0
#*#
#*# [bed_mesh RATOS]
#*# version = 1
#*# points =
#*# 	0.061011, 0.215361, 0.319964, 0.322301, 0.281243, 0.204877, 0.101655
#*# 	-0.133389, 0.054518, 0.183596, 0.212028, 0.187980, 0.110637, -0.012595
#*# 	-0.284163, -0.078227, 0.074505, 0.115692, 0.095028, 0.019811, -0.140253
#*# 	-0.400017, -0.161014, 0.014674, 0.057556, 0.023035, -0.083418, -0.244978
#*# 	-0.457633, -0.204983, -0.016788, 0.028871, -0.012281, -0.136129, -0.311950
#*# 	-0.457057, -0.197316, -0.021848, 0.024973, -0.019545, -0.138329, -0.325739
#*# 	-0.471735, -0.199060, 0.009127, 0.081928, 0.043383, -0.078826, -0.273952
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 465.0
#*# min_y = 30.0
#*# max_y = 460.0
