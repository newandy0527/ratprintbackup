[gcode_macro AFC_POOP_DUMP]
gcode:
  RESPOND TYPE=command MSG="AFC printing_state = {printer.print_stats.state}"
  RESPOND TYPE=command MSG="AFC use_fixed = {printer['gcode_macro AFC_POOP_AT_START_Z'].use_fixed_poop_z}"
  RESPOND TYPE=command MSG="AFC fixed_poop_z = {printer['gcode_macro AFC_POOP_AT_START_Z'].fixed_poop_z}"
  RESPOND TYPE=command MSG="AFC first_layer_z = {printer['gcode_macro AFC_POOP_AT_START_Z'].first_layer_z}"

[gcode_macro AFC_POOP_ENABLE_FIXED_Z]
gcode:
  {% if params.Z is not defined %}
    RESPOND TYPE=command MSG="AFC_POOP: Provide Z value: AFC_POOP_ENABLE_FIXED_Z Z=<mm>"
  {% else %}
    {% set z = params.Z|float %}
    {% if z < 0.1 or z > 50 %}
      RESPOND TYPE=command MSG="AFC_POOP: Z {z} mm out of safe range (0.1–50). Not enabled."
    {% else %}
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=fixed_poop_z VALUE={z}
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=use_fixed_poop_z VALUE=1
      RESPOND TYPE=command MSG="AFC_POOP: Fixed poop Z enabled at {z} mm"
    {% endif %}
  {% endif %}
  
[gcode_macro AFC_POOP_UNSET_FIXED_Z]
gcode:
  SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=use_fixed_poop_z VALUE=0
  RESPOND TYPE=command MSG="AFC_ZSAFE: Fixed poop Z disabled; using captured first-layer Z"

[gcode_macro AFC_POOP]
description: Dispatcher — choose Z‑safe poop when printing, original poop when idle (aware of fixed_poop_z)
rename_existing: AFC_POOP_BASE

gcode:
  {% set printing = printer.print_stats.state == "printing" %}
  {% set afc = printer['gcode_macro AFC_POOP_AT_START_Z'] %}
  {% set use_fixed = afc.use_fixed_poop_z|default(0)|int %}
  {% set fixed_z = afc.fixed_poop_z|default(-999)|float %}
  {% set flz = afc.first_layer_z|default(-999)|float %}

  {% if printing %}
    {% if use_fixed == 1 %}
      {% if fixed_z < 0 %}
        RESPOND TYPE=command MSG="AFC_POOP: Fixed mode enabled but fixed_poop_z invalid → checking captured Z"
        {% if flz >= 0 %}
          RESPOND TYPE=command MSG="AFC_POOP: Captured first-layer Z valid → using AFC_POOP_AT_START_Z"
          AFC_POOP_AT_START_Z
        {% else %}
          RESPOND TYPE=command MSG="AFC_POOP: No valid Z available → using AFC_POOP_BASE"
          AFC_POOP_BASE
        {% endif %}
      {% else %}
        RESPOND TYPE=command MSG="AFC_POOP: Printing + fixed mode enabled → using AFC_POOP_AT_START_Z (fixed Z = {fixed_z} mm)"
        AFC_POOP_AT_START_Z
      {% endif %}
    {% elif flz >= 0 %}
      RESPOND TYPE=command MSG="AFC_POOP: Printing + captured Z → using AFC_POOP_AT_START_Z (captured Z = {flz} mm)"
      AFC_POOP_AT_START_Z
    {% else %}
      RESPOND TYPE=command MSG="AFC_POOP: Printing but no Z captured and fixed mode disabled → using AFC_POOP_BASE"
      AFC_POOP_BASE
    {% endif %}
  {% else %}
    RESPOND TYPE=command MSG="AFC_POOP: Not printing → using AFC_POOP_BASE"
    AFC_POOP_BASE
  {% endif %}
    
[gcode_macro AFC_POOP_AT_START_Z]
variable_max_iteration_length: 40
variable_iteration_z_raise: 6
variable_iteration_z_change: 0.6
variable_max_iterations_per_blob: 3
variable_pressure_release_time: 1000
variable_purge_z: 0
variable_first_layer_z: -1
variable_first_layer_z: -1
variable_use_fixed_poop_z: 0
variable_variable_use_fixed_poop_z: 0
variable_fixed_poop_z: 0.2
variable_variable_fixed_poop_z: 0.2
variable_raise_z_per_blob: 0.5
variable_fixed_z_feed: 600

gcode:
  {% set gVars = printer['gcode_macro _AFC_GLOBAL_VARS'] %}
  {% set travel_speed = (gVars.travel_speed|default(120)) * 60 %}
  {% set z_travel_speed = (gVars.z_travel_speed|default(30)) * 60 %}
  {% set verbose = gVars.verbose|default(1)|int %}
  {% set vars = printer['gcode_macro _AFC_POOP_VARS'] %}

  {% set purge_loc = vars.purge_loc_xy|default([-1,-1]) %}
  {% set purge_x = purge_loc[0]|float %}
  {% set purge_y = purge_loc[1]|float %}

  {% set purge_spd = (vars.purge_spd|default(6.5)) * 60 %}
  {% set z_poop = (vars.z_purge_move|default(true)|string|lower) == 'true' %}
  {% set fast_z = (vars.fast_z|default(200)) * 60 %}
  {% set z_lift = vars.z_lift|default(10)|float %}
  {% set part_cooling_fan = (vars.part_cooling_fan|default(true)|string|lower) == 'true' %}
  {% set part_cooling_fan_speed = vars.part_cooling_fan_speed|default(1.0)|float %}
  {% set purge_cool_time = (vars.purge_cool_time|default(2)) * 1000 %}
  {% set purge_length = vars.purge_length|default(72.0)|float %}
  {% set purge_length_minimum = vars.purge_length_minimum|default(60.0)|float %}
  {% set purge_start = vars.purge_start|default(0.6)|float %}
  {% set restore_position = (vars.restore_position|default(true)|string|lower) == 'true' %}

  {% if verbose > 0 %}
    RESPOND TYPE=command MSG="AFC_Poop: Starting poop"
  {% endif %}

  SAVE_GCODE_STATE NAME=_AFC_POOPING

  {% if part_cooling_fan %}
    {% set backup_fan_speed = printer.fan.speed %}
    M106 S{ (part_cooling_fan_speed * 255)|int }
  {% endif %}

  {% set backup_feedrate = printer.gcode_move.speed_factor %}
  M220 S100

  {% if params.PURGE_LENGTH %}
    {% set purge_len = params.PURGE_LENGTH|float %}
  {% else %}
    {% set purge_len = purge_length %}
  {% endif %}

  {% if purge_len < purge_length_minimum %}
    {% set purge_len = purge_length_minimum %}
  {% endif %}

  G90
  AFC_DISABLE_SKEW

  G1 X{purge_x} Y{purge_y} F{travel_speed}

  # --- First-layer Z handling (robust: check attribute and variable forms) ---
  {% set afc = printer['gcode_macro AFC_POOP_AT_START_Z'] %}

  # read both possible "use fixed" names
  {% set use_fixed_attr = afc.use_fixed_poop_z|default(None) %}
  {% set use_fixed_var = afc.variable_use_fixed_poop_z|default(None) %}
  {% if use_fixed_attr is not none %}
    {% set use_fixed = use_fixed_attr|int %}
  {% elif use_fixed_var is not none %}
    {% set use_fixed = use_fixed_var|int %}
  {% else %}
    {% set use_fixed = 0 %}
  {% endif %}

  # read both possible fixed Z names
  {% set fixed_attr = afc.fixed_poop_z|default(None) %}
  {% set fixed_var = afc.variable_fixed_poop_z|default(None) %}
  {% if fixed_attr is not none %}
    {% set fixed_z = fixed_attr|float %}
  {% elif fixed_var is not none %}
    {% set fixed_z = fixed_var|float %}
  {% else %}
    {% set fixed_z = -999.0 %}
  {% endif %}

  # read both possible captured first-layer Z names
  {% set flz_attr = afc.first_layer_z|default(None) %}
  {% set flz_var = afc.variable_first_layer_z|default(None) %}
  {% if flz_attr is not none and flz_attr|float >= -998 %}
    {% set flz = flz_attr|float %}
  {% elif flz_var is not none %}
    {% set flz = flz_var|float %}
  {% else %}
    {% set flz = -999.0 %}
  {% endif %}

  # Read header variables into local names (safe access)
  {% set raise_z_per_blob = afc.variable_raise_z_per_blob|default(0.5)|float %}
  {% set fixed_z_feed = afc.variable_fixed_z_feed|default(600)|float %}

  # Prefer fixed mode when enabled and valid
  {% if use_fixed == 1 and fixed_z >= 0 %}
    {% if fixed_z < 0.05 or fixed_z > 50 %}
      RESPOND TYPE=command MSG="AFC_ZSAFE ERROR: fixed_poop_z %0.3f mm out of safe range (0.05–50)." % fixed_z
      { action_raise_error("AFC_ZSAFE ERROR: invalid fixed_poop_z") }
    {% else %}
      # Make fixed value canonical for downstream macros (write both forms)
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=first_layer_z VALUE={fixed_z}
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=variable_first_layer_z VALUE={fixed_z}
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=use_fixed_poop_z VALUE=1
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=variable_use_fixed_poop_z VALUE=1
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=fixed_poop_z VALUE={fixed_z}
      SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=variable_fixed_poop_z VALUE={fixed_z}
      RESPOND TYPE=command MSG="AFC_ZSAFE: Fixed mode enabled — first_layer_z set to {fixed_z} mm"
      {% set flz = fixed_z %}
    {% endif %}

  # Else use captured first-layer Z if it looks reasonable
  {% elif flz >= 0 and flz <= 5.0 %}
    SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=first_layer_z VALUE={flz}
    SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=variable_first_layer_z VALUE={flz}
    RESPOND TYPE=command MSG="AFC_ZSAFE: Using captured first-layer Z = {flz} mm"

  # Else no usable Z available
  {% else %}
    {% set _msg = "AFC_ZSAFE ERROR: No valid first_layer_z captured and fixed_poop_z not enabled or invalid (captured = %0.3f)" % flz %}
    { action_raise_error(_msg) }
  {% endif %}

  # Ensure actual toolhead Z is read after motion completes
  M400
  {% set actual_z = printer.toolhead.position.z|float %}

  RESPOND TYPE=command MSG="AFC_ZSAFE: Stored first-layer Z = {flz}"
  RESPOND TYPE=command MSG="AFC_ZSAFE: Current actual Z = {actual_z}"

  {% if z_poop %}
      G1 Z{ flz + purge_start } F{ z_travel_speed }
  {% endif %}

  {% set iterations = (purge_len / max_iteration_length)|round(0,'ceil')|int %}

  {% for n in range(iterations) %}
    {% set step = n % max_iterations_per_blob %}

    {% if step == 0 and z_poop %}
        G1 Z{ flz + purge_start } F{ z_travel_speed }
    {% endif %}

    {% set purge_amount_left = purge_len - (max_iteration_length * n) %}
    {% if purge_amount_left < max_iteration_length %}
        {% set extrude_amount = purge_amount_left %}
    {% else %}
        {% set extrude_amount = max_iteration_length %}
    {% endif %}

    {% set extrude_ratio = extrude_amount / max_iteration_length %}

    G91
    M83

    {% set step_triangular = (step * (step + 1)) / 2 %}

    {% if step == 0 %}
        {% set z_raise_sub = purge_start %}
    {% else %}
        {% set z_raise_sub = step_triangular * iteration_z_change %}
    {% endif %}

    {% set raise_z = (iteration_z_raise - z_raise_sub) * extrude_ratio %}
    {% if raise_z < 0 %}
        {% set raise_z = 0 %}
    {% endif %}

    {% set duration = extrude_amount / purge_spd %}

    {% if z_poop %}
      {% if duration > 0 %}
        {% set speed = (raise_z / duration) * 60 %}
      {% else %}
        {% set speed = fixed_z_feed %}
      {% endif %}
      G1 Z{raise_z} E{extrude_amount} F{speed}
    {% else %}
      G1 E{extrude_amount} F{purge_spd}
    {% endif %}

    {% set max_iter_reached = step == (max_iterations_per_blob - 1) %}
    {% set purge_done = purge_len - max_iteration_length * (n + 1) <= 0 %}

    {% if max_iter_reached or purge_done %}
      G4 P{purge_cool_time}
    {% endif %}
  {% endfor %}

  G90

  {% set final_poop_height = flz + purge_start + (iterations * iteration_z_raise) %}
  {% set new_z = final_poop_height + z_lift %}

  {% if z_poop %}
    G1 Z{new_z} F{fast_z}
  {% endif %}

  {% if part_cooling_fan %}
    M106 S{ (backup_fan_speed * 255)|int }
  {% endif %}

  M220 S{ (backup_feedrate * 100)|int }

  AFC_ENABLE_SKEW

  RESTORE_GCODE_STATE NAME=_AFC_POOPING MOVE={ 1 if restore_position else 0 }