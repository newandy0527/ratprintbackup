[gcode_macro AFC_POOP]
description: Dispatcher — choose Z‑safe poop when printing, original poop when idle
rename_existing: AFC_POOP_BASE

gcode:
  {% set printing = printer.print_stats.state == "printing" %}
  {% set flz = printer["gcode_macro AFC_POOP_AT_START_Z"].first_layer_z | float %}

  {% if printing and flz >= 0 %}
      RESPOND TYPE=command MSG="AFC_POOP: Printing + valid Z → using AFC_POOP_AT_START_Z"
      AFC_POOP_AT_START_Z
  {% else %}
      {% if printing and flz < 0 %}
          RESPOND TYPE=command MSG="AFC_POOP: Printing but NO Z captured → using AFC_POOP_BASE"
      {% else %}
          RESPOND TYPE=command MSG="AFC_POOP: Not printing → using AFC_POOP_BASE"
      {% endif %}
      AFC_POOP_BASE
  {% endif %}
    
[gcode_macro AFC_POOP_AT_START_Z]
variable_max_iteration_length: 40
variable_iteration_z_raise: 6
variable_iteration_z_change: 0.6
variable_max_iterations_per_blob: 3
variable_pressure_release_time: 1000
variable_purge_z: 0
variable_first_layer_z: -1

gcode:
  {% set gVars = printer['gcode_macro _AFC_GLOBAL_VARS'] %}
  {% set travel_speed = (gVars.travel_speed|default(120)) * 60 %}
  {% set z_travel_speed = (gVars.z_travel_speed|default(30)) * 60 %}
  {% set verbose = gVars.verbose|default(1)|int %}
  {% set vars = printer['gcode_macro _AFC_POOP_VARS'] %}

  {% set purge_loc = vars.purge_loc_xy|default([-1,-1]) %}
  {% set purge_x = purge_loc[0]|float %}
  {% set purge_y = purge_loc[1]|float %}

  {% set purge_spd = (vars.purge_spd|default(6.5)) * 60 %}
  {% set z_poop = (vars.z_purge_move|default(true)|string|lower) == 'true' %}
  {% set fast_z = (vars.fast_z|default(200)) * 60 %}
  {% set z_lift = vars.z_lift|default(10)|float %}
  {% set part_cooling_fan = (vars.part_cooling_fan|default(true)|string|lower) == 'true' %}
  {% set part_cooling_fan_speed = vars.part_cooling_fan_speed|default(1.0)|float %}
  {% set purge_cool_time = (vars.purge_cool_time|default(2)) * 1000 %}
  {% set purge_length = vars.purge_length|default(72.111)|float %}
  {% set purge_length_minimum = vars.purge_length_minimum|default(60.999)|float %}
  {% set purge_start = vars.purge_start|default(0.6)|float %}
  {% set restore_position = (vars.restore_position|default(true)|string|lower) == 'true' %}

  {% if verbose > 0 %}
    RESPOND TYPE=command MSG="AFC_Poop: Starting poop"
  {% endif %}

  SAVE_GCODE_STATE NAME=_AFC_POOPING

  {% if part_cooling_fan %}
    {% set backup_fan_speed = printer.fan.speed %}
    M106 S{ (part_cooling_fan_speed * 255)|int }
  {% endif %}

  {% set backup_feedrate = printer.gcode_move.speed_factor %}
  M220 S100

  {% if params.PURGE_LENGTH %}
    {% set purge_len = params.PURGE_LENGTH|float %}
  {% else %}
    {% set purge_len = purge_length %}
  {% endif %}

  {% if purge_len < purge_length_minimum %}
    {% set purge_len = purge_length_minimum %}
  {% endif %}

  G90
  AFC_DISABLE_SKEW

  G1 X{purge_x} Y{purge_y} F{travel_speed}

  # --- First-layer Z handling ---
  {% set flz = printer["gcode_macro AFC_POOP_AT_START_Z"].first_layer_z|float %}
  {% set actual_z = printer.toolhead.position.z|float %}

  {% if flz < 0 %}
      { action_raise_error("AFC_ZSAFE ERROR: first_layer_z was never captured in START_PRINT!") }
  {% endif %}

  {% if flz > 1.0 %}
      { action_raise_error("AFC_ZSAFE ERROR: first_layer_z is too high: %0.3f mm" % flz) }
  {% endif %}

  RESPOND TYPE=command MSG="AFC_ZSAFE: Stored first-layer Z = {flz}"
  RESPOND TYPE=command MSG="AFC_ZSAFE: Current actual Z = {actual_z}"

  {% if z_poop %}
      G1 Z{ flz + purge_start } F{ z_travel_speed }
  {% endif %}

  {% set iterations = (purge_len / max_iteration_length)|round(0,'ceil')|int %}

  {% for n in range(iterations) %}
    {% set step = n % max_iterations_per_blob %}

    {% if step == 0 and z_poop %}
        G1 Z{ flz + purge_start } F{ z_travel_speed }
    {% endif %}

    {% set purge_amount_left = purge_len - (max_iteration_length * n) %}
    {% if purge_amount_left < max_iteration_length %}
        {% set extrude_amount = purge_amount_left %}
    {% else %}
        {% set extrude_amount = max_iteration_length %}
    {% endif %}

    {% set extrude_ratio = extrude_amount / max_iteration_length %}

    G91
    M83

    {% set step_triangular = (step * (step + 1)) / 2 %}

    {% if step == 0 %}
        {% set z_raise_sub = purge_start %}
    {% else %}
        {% set z_raise_sub = step_triangular * iteration_z_change %}
    {% endif %}

    {% set raise_z = (iteration_z_raise - z_raise_sub) * extrude_ratio %}
    {% if raise_z < 0 %}
        {% set raise_z = 0 %}
    {% endif %}

    {% set duration = extrude_amount / purge_spd %}

    {% if z_poop %}
      {% set speed = raise_z / duration %}
      G1 Z{raise_z} E{extrude_amount} F{speed}
    {% else %}
      G1 E{extrude_amount} F{purge_spd}
    {% endif %}

    {% set max_iter_reached = step == (max_iterations_per_blob - 1) %}
    {% set purge_done = purge_len - max_iteration_length * (n + 1) <= 0 %}

    {% if max_iter_reached or purge_done %}
      G4 P{purge_cool_time}
    {% endif %}
  {% endfor %}

  G90

  {% set final_poop_height = flz + purge_start + (iterations * iteration_z_raise) %}
  {% set new_z = final_poop_height + z_lift %}

  {% if z_poop %}
    G1 Z{new_z} F{fast_z}
  {% endif %}

  {% if part_cooling_fan %}
    M106 S{ (backup_fan_speed * 255)|int }
  {% endif %}

  M220 S{ (backup_feedrate * 100)|int }

  AFC_ENABLE_SKEW

  RESTORE_GCODE_STATE NAME=_AFC_POOPING MOVE={ 1 if restore_position else 0 }