[gcode_macro AFC_POOP]
description: Conditional AFC poop override (Z-safe only during printing)
rename_existing: AFC_POOP_BASE
gcode:
    {% if printer.print_stats.state == "printing" %}
        RESPOND TYPE=command MSG="AFC_ZSAFE: Printing detected → Using Z-safe poop wrapper"
        AFC_POOP_AT_START_Z
    {% else %}
        RESPOND TYPE=command MSG="AFC_ZSAFE: Not printing → Using original afc_poop"
        AFC_POOP_BASE
    {% endif %}
#[gcode_macro AFC_POOP]
#description: Override internal AFC poop entry point to use Z-safe wrapper
#rename_existing: AFC_POOP_BASE
#gcode:
#    RESPOND TYPE=command MSG="AFC_ZSAFE: _AFC_POOP triggered"
#    AFC_POOP_AT_START_Z

[gcode_macro AFC_POOP_AT_START_Z]
description: Z-aware wrapper with diagnostic echo
variable_saved_z: 0
variable_first_layer_z: -1

gcode:
    {% set current_z = printer.toolhead.position.z %}
    SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=saved_z VALUE={current_z}

    RESPOND TYPE=command MSG="AFC_ZSAFE: Current Z = {current_z}"

    {% set flz = printer["gcode_macro AFC_POOP_AT_START_Z"].first_layer_z|float %}

    {% if flz < 0 %}
        SET_GCODE_VARIABLE MACRO=AFC_POOP_AT_START_Z VARIABLE=first_layer_z VALUE={current_z}
        RESPOND TYPE=command MSG="AFC_ZSAFE: First-layer Z captured = {current_z}"
        {% set flz = current_z %}
    {% else %}
        RESPOND TYPE=command MSG="AFC_ZSAFE: First-layer Z already stored = {flz}"
    {% endif %}

    RESPOND TYPE=command MSG="AFC_ZSAFE: Moving to poop Z = {flz + 0.20}"

    G90
    G1 Z{flz + 0.20} F6000

    RESPOND TYPE=command MSG="AFC_ZSAFE: Calling afc_poop..."
    #afc_poop
    AFC_POOP_BASE

    RESPOND TYPE=command MSG="AFC_ZSAFE: Restoring Z = {saved_z}"
    G1 Z{saved_z} F6000

    RESPOND TYPE=command MSG="AFC_ZSAFE: Poop complete"

#[gcode_macro _AFC_POOP]
#description: Override internal AFC poop entry point to use Z-safe wrapper
#gcode:
#    RESPOND TYPE=command MSG="AFC_ZSAFE: _AFC_POOP triggered"
#    AFC_POOP_AT_START_Z