#New AFC_POOP that routes through Z-aware poop logic
[gcode_macro afc_poop]
rename_existing: AFC_POOP_BASE
gcode:
    MMU_POOP_AT_START_Z

[gcode_macro SET_PRINT_STATS_INFO]
rename_existing: _SET_PRINT_STATS_INFO

gcode:
    _SET_PRINT_STATS_INFO {rawparams}
    _CAPTURE_START_Z

# ============================
#  Z capture hook
# ============================

[gcode_macro _CAPTURE_START_Z]
variable_start_z: 0.0
variable_captured: False

gcode:
    {% if not printer["gcode_macro _CAPTURE_START_Z"].captured %}
        {% set z = printer.toolhead.position.z %}
        SET_GCODE_VARIABLE MACRO=_CAPTURE_START_Z VARIABLE=start_z VALUE={z}
        SET_GCODE_VARIABLE MACRO=_CAPTURE_START_Z VARIABLE=captured VALUE=True
        RESPOND PREFIX="start_z" MSG="Captured first-layer Z = {z}"
    {% else %} 
        RESPOND PREFIX="start_z" MSG="Z already captured: {printer['gcode_macro _CAPTURE_START_Z'].start_z}"
    {% endif %}

# ============================
#  Continuous Z-lift loop
# ============================

[delayed_gcode POOP_LIFT_LOOP]
gcode:
    {% set poop = printer["gcode_macro MMU_POOP_AT_START_Z"] %}
    {% set lift_rate = poop.lift_rate %}
    {% set interval = poop.lift_interval %}
    {% set max_z = poop.max_lift_z %}
    {% set current_z = printer.toolhead.position.z %}
    {% set next_z = current_z + lift_rate %}

    {% if next_z < max_z %}
        G1 Z{next_z} F3000
        UPDATE_DELAYED_GCODE ID=POOP_LIFT_LOOP DURATION={interval}
    {% else %}
        RESPOND PREFIX="poop" MSG="Lift loop reached max_z={max_z}, stopping"
    {% endif %}


# ============================
#  Main Z-aware poop macro
# ============================

[gcode_macro MMU_POOP_AT_START_Z]
variable_enable_fixed_lift: False
variable_fixed_lift: 2.0

variable_enable_continuous_lift: False
variable_lift_rate: 0.05
variable_lift_interval: 0.1
variable_max_lift_z: 30.0

variable_pooper_lift_z: 10.0
variable_return_delay: 0.5

variable_poop_x: 455.0
variable_poop_y: 5.0

variable_enable_poop_xy_move: True

gcode:
    {% set current_z = printer.toolhead.position.z %}
    {% set safe_z = current_z + 2.0 %}
    {% set cap = printer["gcode_macro _CAPTURE_START_Z"] %}
    {% set start_z = cap.start_z %}
    {% set captured = cap.captured %}
    {% set current_z = printer.toolhead.position.z %}
    {% set enable_fixed = printer["gcode_macro MMU_POOP_AT_START_Z"].enable_fixed_lift %}
    {% set fixed_lift = printer["gcode_macro MMU_POOP_AT_START_Z"].fixed_lift %}
    {% set enable_cont = printer["gcode_macro MMU_POOP_AT_START_Z"].enable_continuous_lift %}
    {% set lift_rate = printer["gcode_macro MMU_POOP_AT_START_Z"].lift_rate %}
    {% set lift_interval = printer["gcode_macro MMU_POOP_AT_START_Z"].lift_interval %}
    {% set max_lift_z = printer["gcode_macro MMU_POOP_AT_START_Z"].max_lift_z %}
    {% set pooper_lift_z = printer["gcode_macro MMU_POOP_AT_START_Z"].pooper_lift_z %}
    {% set return_delay = printer["gcode_macro MMU_POOP_AT_START_Z"].return_delay %}
    {% set original_pos = printer.toolhead.position %}
    {% set enable_xy = printer["gcode_macro MMU_POOP_AT_START_Z"].enable_poop_xy_move %}
    {% set poop_x = printer["gcode_macro MMU_POOP_AT_START_Z"].poop_x %}
    {% set poop_y = printer["gcode_macro MMU_POOP_AT_START_Z"].poop_y %}
    
    # --- INITIAL SAFETY LIFT ---
    {% if pooper_lift_z > 0 %}
        G91
        G1 Z{pooper_lift_z} F600
        G90
        RESPOND PREFIX="poop" MSG="Lifted nozzle {pooper_lift_z}mm to avoid part"
    {% endif %}

    # --- MOVE TO POOP LOCATION ---
    {% if enable_xy %}
        G1 X{poop_x} Y{poop_y} F6000
        RESPOND PREFIX="poop" MSG="Moved to poop location X={poop_x}, Y={poop_y}"
    {% else %}
        RESPOND PREFIX="poop" MSG="Poop XY move disabled â€” staying at current position"
    {% endif %}
    
    # --- DROP TO START Z ---
        G1 Z{start_z} F6000
        RESPOND PREFIX="poop" MSG="Dropped to start_z = {start_z}"

    # --- CONFIG VALIDATION ---
    {% if not enable_fixed and not enable_cont %}
        RESPOND PREFIX="poop" MSG="WARNING: Both fixed_lift and continuous_lift are disabled. Poop will run at flat Z."
    {% endif %}

    {% if enable_fixed and fixed_lift <= 0 %}
        RESPOND PREFIX="poop" MSG="WARNING: fixed_lift <= 0 but enabled. Disabling fixed_lift for this run."
        {% set enable_fixed = False %}
    {% endif %}

    {% if enable_cont and lift_rate <= 0 %}
        RESPOND PREFIX="poop" MSG="ERROR: lift_rate must be > 0 for continuous lift. Disabling continuous lift for this run."
        {% set enable_cont = False %}
    {% endif %}

    {% if enable_cont and lift_interval <= 0 %}
        RESPOND PREFIX="poop" MSG="ERROR: lift_interval must be > 0. Disabling continuous lift for this run."
        {% set enable_cont = False %}
    {% endif %}

    {% if max_lift_z <= 0 %}
        RESPOND PREFIX="poop" MSG="ERROR: max_lift_z <= 0. Clamping to 10mm for this run."
        {% set max_lift_z = 10.0 %}
    {% endif %}

    # --- SAFETY CHECKS ---
    {% if not captured %}
        RESPOND PREFIX="poop" MSG="ERROR: start_z not captured. Aborting poop."
        CANCEL_PRINT
        M106 S0
    {% endif %}

    {% if start_z < 0 %}
        RESPOND PREFIX="poop" MSG="WARNING: start_z < 0. Clamping to 0."
        {% set start_z = 0.0 %}
    {% endif %}

    RESPOND PREFIX="poop" MSG="Poop start: current_z={current_z}, start_z={start_z}, max_lift_z={max_lift_z}"

    # --- MOVE TO START Z ---
    G1 Z{start_z} F6000
    RESPOND PREFIX="poop" MSG="Moved to start_z"

    # --- FIXED LIFT ---
    {% if enable_fixed %}
        {% set target_z = start_z + fixed_lift %}
        {% if target_z > max_lift_z %}
            RESPOND PREFIX="poop" MSG="WARNING: fixed_lift would exceed max_lift_z. Clamping to {max_lift_z}."
            {% set target_z = max_lift_z %}
        {% endif %}
        G1 Z{target_z} F6000
        RESPOND PREFIX="poop" MSG="Applied fixed lift to Z={target_z}"
    {% endif %}

    # --- CONTINUOUS LIFT ---
    {% if enable_cont %}
        RESPOND PREFIX="poop" MSG="Starting continuous lift loop..."
        UPDATE_DELAYED_GCODE ID=POOP_LIFT_LOOP DURATION={lift_interval}
    {% endif %}

    # --- RUN ORIGINAL POOP ---
    AFC_POOP_BASE
    RESPOND PREFIX="poop" MSG="AFC_POOP_BASE completed"

    # --- STOP CONTINUOUS LIFT ---
    {% if enable_cont %}
        UPDATE_DELAYED_GCODE ID=POOP_LIFT_LOOP DURATION=0
        RESPOND PREFIX="poop" MSG="Continuous lift loop stopped"
    {% endif %}

    # --- RETURN TO POOP XY OR ORIGINAL XY, THEN RETURN TO ORIGINAL Z ---
    {% if printer.print_stats.state == 'printing' %}
    # If printing, move to configured poop location
        G1 X{poop_x} Y{poop_y} F6000
        RESPOND PREFIX="poop" MSG="Moved to poop XY ({poop_x},{poop_y})"
    {% else %}
    # If not printing, return to the original XY
        G1 X{original_pos.x} Y{original_pos.y} F6000
        RESPOND PREFIX="poop" MSG="Returned to original XY"
   
        {% if return_delay|default(0) > 0 %}
            G4 P{(return_delay * 1000)|int}
            RESPOND PREFIX="poop" MSG="Waited {return_delay}s before Z drop"
        {% endif %}
      
      #Return to the original Z position
        G1 Z{original_pos.z} F600
        RESPOND PREFIX="poop" MSG="Returned to original Z"
   
   {% endif %}
   
# ============================
#  Poop Preview (moves + extrudes)
# ============================

[gcode_macro POOP_PREVIEW]
description: "Simulate a poop event and show settings"
gcode:
    {% set cap = printer["gcode_macro _CAPTURE_START_Z"] %}
    {% set captured = cap.captured %}
    {% set start_z = cap.start_z %}
    {% set current_z = printer.toolhead.position.z %}
    {% set poop = printer["gcode_macro MMU_POOP_AT_START_Z"] %}

    {% set enable_fixed = poop.enable_fixed_lift %}
    {% set fixed_lift = poop.fixed_lift %}
    {% set enable_cont = poop.enable_continuous_lift %}
    {% set lift_rate = poop.lift_rate %}
    {% set lift_interval = poop.lift_interval %}
    {% set max_lift_z = poop.max_lift_z %}

    RESPOND PREFIX="preview" MSG="=== Poop Settings Summary ==="
    RESPOND PREFIX="preview" MSG="Captured start_z        : {captured}"
    RESPOND PREFIX="preview" MSG="Stored start_z value     : {start_z}"
    RESPOND PREFIX="preview" MSG="Fixed lift enabled       : {enable_fixed}"
    RESPOND PREFIX="preview" MSG="Fixed lift height (mm)   : {fixed_lift}"
    RESPOND PREFIX="preview" MSG="Cont. lift enabled       : {enable_cont}"
    RESPOND PREFIX="preview" MSG="Cont. lift rate (mm/step): {lift_rate}"
    RESPOND PREFIX="preview" MSG="Cont. lift interval (s)  : {lift_interval}"
    RESPOND PREFIX="preview" MSG="Max lift Z (mm)          : {max_lift_z}"
    RESPOND PREFIX="preview" MSG="Current Z before preview : {current_z}"
    RESPOND PREFIX="preview" MSG="=============================="

    # --- HANDLE MISSING Z CAPTURE ---
    {% if not captured %}
        RESPOND PREFIX="preview" MSG="No captured start_z found. Using current Z."
        {% set start_z = current_z %}
    {% endif %}

    {% if start_z < 0 %}
        RESPOND PREFIX="preview" MSG="WARNING: start_z < 0. Clamping to 0."
        {% set start_z = 0.0 %}
    {% endif %}

    RESPOND PREFIX="preview" MSG="Preview using start_z={start_z}, current_z={current_z}"

    # --- MOVE TO START Z ---
    G1 Z{start_z} F6000
    RESPOND PREFIX="preview" MSG="Moved to preview Z"

    # --- FIXED LIFT ---
    {% if enable_fixed and fixed_lift > 0 %}
        {% set target_z = start_z + fixed_lift %}
        {% if target_z > max_lift_z %}
            {% set target_z = max_lift_z %}
        {% endif %}
        G1 Z{target_z} F6000
        RESPOND PREFIX="preview" MSG="Applied fixed lift to Z={target_z}"
    {% endif %}

    # --- CONTINUOUS LIFT ---
    {% if enable_cont and lift_rate > 0 and lift_interval > 0 %}
        UPDATE_DELAYED_GCODE ID=POOP_LIFT_LOOP DURATION={lift_interval}
        RESPOND PREFIX="preview" MSG="Continuous lift loop started"
    {% endif %}

    # --- SIMULATED EXTRUSION ---
    RESPOND PREFIX="preview" MSG="Simulating poop extrusion..."
    G1 E10 F300

    # --- STOP CONTINUOUS LIFT ---
    {% if enable_cont and lift_rate > 0 and lift_interval > 0 %}
        UPDATE_DELAYED_GCODE ID=POOP_LIFT_LOOP DURATION=0
        RESPOND PREFIX="preview" MSG="Continuous lift loop stopped"
    {% endif %}

    # --- RETURN TO ORIGINAL Z ---
    G1 Z{current_z} F6000
    RESPOND PREFIX="preview" MSG="Returned to original Z"


# ============================
#  POOP_SHOW_CONFIG (no motion)
# ============================

[gcode_macro POOP_SHOW_CONFIG]
description: "Show poop subsystem settings only (no movement)"
gcode:
    {% set cap = printer["gcode_macro _CAPTURE_START_Z"] %}
    {% set captured = cap.captured %}
    {% set start_z = cap.start_z %}
    {% set current_z = printer.toolhead.position.z %}
    {% set poop = printer["gcode_macro MMU_POOP_AT_START_Z"] %}

    {% set captured_text = "YES" if captured else "NO" %}

    RESPOND PREFIX="config" MSG="=== Poop Settings Summary (NO MOTION) ==="
    RESPOND PREFIX="config" MSG="Captured start_z        : {captured_text}"
    RESPOND PREFIX="config" MSG="Stored start_z value     : {start_z}"
    RESPOND PREFIX="config" MSG="Fixed lift enabled       : {poop.enable_fixed_lift}"
    RESPOND PREFIX="config" MSG="Fixed lift height (mm)   : {poop.fixed_lift}"
    RESPOND PREFIX="config" MSG="Cont. lift enabled       : {poop.enable_continuous_lift}"
    RESPOND PREFIX="config" MSG="Cont. lift rate (mm/step): {poop.lift_rate}"
    RESPOND PREFIX="config" MSG="Cont. lift interval (s)  : {poop.lift_interval}"
    RESPOND PREFIX="config" MSG="Max lift Z (mm)          : {poop.max_lift_z}"
    RESPOND PREFIX="config" MSG="Current Z                : {current_z}"
    RESPOND PREFIX="config" MSG="========================================="

    {% if not poop.enable_fixed_lift and not poop.enable_continuous_lift %}
        RESPOND PREFIX="config" MSG="NOTE: Both lift modes disabled. Poop will be flat."
    {% endif %}

    {% if poop.enable_fixed_lift and poop.fixed_lift <= 0 %}
        RESPOND PREFIX="config" MSG="NOTE: fixed_lift <= 0 but enabled. It will be ignored at runtime."
    {% endif %}

    {% if poop.enable_continuous_lift and poop.lift_rate <= 0 %}
        RESPOND PREFIX="config" MSG="NOTE: lift_rate <= 0 with continuous lift enabled. Runtime will disable continuous lift."
    {% endif %}

    {% if poop.enable_continuous_lift and poop.lift_interval <= 0 %}
        RESPOND PREFIX="config" MSG="NOTE: lift_interval <= 0 with continuous lift enabled. Runtime will disable continuous lift."
    {% endif %}

    {% if poop.max_lift_z <= 0 %}
        RESPOND PREFIX="config" MSG="NOTE: max_lift_z <= 0. Runtime will clamp to 10mm."
    {% endif %}


