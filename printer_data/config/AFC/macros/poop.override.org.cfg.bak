[gcode_macro MMU_POOP_AT_START_Z]
description: Move to first-layer Z before pooping
variable_start_z: 0
variable_restore_z: 0

gcode:
    # Cache the current Z so we can restore it after pooping
    {% set current_z = printer.toolhead.position.z|float %}
    SET_GCODE_VARIABLE MACRO=MMU_POOP_AT_START_Z VARIABLE=restore_z VALUE={current_z}

    # Move to the stored first-layer Z (set earlier in START_PRINT)
    G1 Z{start_z} F6000

    # Perform the actual poop using AFC logic
    AFC_POOP

    # Restore the Z height we were at before pooping
    G1 Z{restore_z} F6000
