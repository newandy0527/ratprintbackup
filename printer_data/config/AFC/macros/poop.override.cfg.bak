[gcode_macro MMU_POOP_AT_START_Z]
description: Move to first-layer Z before pooping (with Z safety guards)
variable_start_z: 0
variable_restore_z: 0

gcode:
    # Read current Z
    {% set current_z = printer.toolhead.position.z|float %}

    # Define a minimum safe Z height (never go below this)
    {% set z_safe = 0.2 %}

    # Clamp the stored first-layer Z to a safe minimum
    {% set target_start_z = [start_z|float, z_safe]|max %}

    # Clamp the restore Z to a safe minimum
    {% set target_restore_z = [current_z, z_safe]|max %}

    # Save the clamped restore Z
    SET_GCODE_VARIABLE MACRO=MMU_POOP_AT_START_Z VARIABLE=restore_z VALUE={target_restore_z}

    # Move to the stored first-layer Z (safe)
    G1 Z{target_start_z} F6000

    # Perform the actual poop
    AFC_POOP

    # Restore the previous Z height (safe)
    G1 Z{restore_z} F6000

